<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ù‡§æ‡§Å‡§∏‡•Ä ‡§ï‡•á‡§∏‡§∞ ‡§¶‡§≤ - ‡§™‡•ç‡§∞‡•ã ‡§∏‡§®‡§æ‡§§‡§®‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§°</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background-color: #f4f4f4; padding-bottom: 80px; }
        .header { background: linear-gradient(135deg, #ff9933, #ff6600); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; display: none; animation: fadeIn 0.4s; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn { background: #ff6600; color: white; border: none; padding: 12px; border-radius: 25px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        input, select, textarea { width: 95%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; }
        
        /* ID Card Design */
        .id-capture-wrapper { background: white; padding: 15px; display: inline-block; border: 1px solid #ddd; }
        .id-card-box { width: 380px; height: 230px; background: #fff5e6; border: 3px solid #ff4500; border-radius: 12px; position: relative; overflow: hidden; margin-bottom: 15px; }
        .aadhaar-header { background: #ff4500; color: white; padding: 10px; text-align: center; font-weight: bold; }
        .aadhaar-body { display: flex; padding: 15px; background: white; height: 160px; position: relative; }
        .watermark-bg { position: absolute; opacity: 0.15; width: 65%; left: 17.5%; top: 15%; z-index: 0; pointer-events: none; }
        .id-photo { width: 105px; height: 130px; border: 2px solid #ff4500; object-fit: cover; border-radius: 8px; z-index: 1; }
        .aadhaar-info { flex: 1; padding-left: 15px; z-index: 1; text-align: left; }
        .aadhaar-info b { font-size: 10px; color: #555; display: block; }
        .aadhaar-info span { font-size: 14px; font-weight: bold; display: block; margin-bottom: 4px; }
        .aadhaar-footer { background: #ff4500; color: white; text-align: center; padding: 8px; font-weight: bold; position: absolute; bottom: 0; width: 100%; }

        /* Legal Box */
        .rules-box { width: 380px; background: #fff; border: 2px solid #ff4500; border-radius: 12px; padding: 15px; text-align: left; font-size: 11px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header"><h1>‡§ù‡§æ‡§Å‡§∏‡•Ä ‡§ï‡•á‡§∏‡§∞ ‡§¶‡§≤</h1></div>

    <div id="join-page" class="container active-page">
        <div class="card">
            <h2>‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£</h2>
            <button class="btn" style="background:#4285F4;" onclick="loginWithGoogle()" id="googleLoginBtn">G Google Login</button>
            <label>‡§Ö‡§™‡§®‡§æ ‡§¶‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç:</label>
            <select id="userOrgSelect">
                <option value="‡§ù‡§æ‡§Å‡§∏‡•Ä ‡§ï‡•á‡§∏‡§∞ ‡§¶‡§≤">‡§ù‡§æ‡§Å‡§∏‡•Ä ‡§ï‡•á‡§∏‡§∞ ‡§¶‡§≤</option>
                <option value="‡§¨‡§ú‡§∞‡§Ç‡§ó ‡§¶‡§≤">‡§¨‡§ú‡§∞‡§Ç‡§ó ‡§¶‡§≤</option>
            </select>
            <input type="text" id="userName" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ">
            <input type="text" id="userEmail" placeholder="Email (Login ‡§∏‡•á ‡§≠‡§∞‡•á‡§ó‡§æ)" disabled>
            <input type="text" id="fatherName" placeholder="‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ">
            <textarea id="userAddress" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§™‡§§‡§æ"></textarea>
            <input type="date" id="dob">
            
            <div style="border: 2px dashed #999; padding: 10px; text-align: center;" onclick="document.getElementById('photoInput').click()">üì∑ ‡§Ö‡§™‡§®‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç</div>
            <input type="file" id="photoInput" style="display: none;" onchange="compressAndPreview(this, 'photoPreview')">
            <img id="photoPreview" style="width:100px; height:120px; display:none; margin: 10px auto;">

            <div style="border: 2px dashed #999; padding: 10px; margin-top: 10px; text-align: center;" onclick="document.getElementById('docInput').click()">üìë ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£ (‡§Ü‡§ß‡§æ‡§∞/PAN)</div>
            <input type="file" id="docInput" style="display: none;" onchange="validateGovtDocument(this)">
            <p id="docStatus" style="font-size: 11px; text-align: center; font-weight: bold;"></p>

            <button class="btn" id="submitBtn" onclick="generateUserID()" disabled>ID ‡§ï‡§æ‡§∞‡•ç‡§° ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç üîí</button>
        </div>
    </div>

    <div id="id-page" class="container">
        <div style="text-align: center;">
            <div id="captureArea" class="id-capture-wrapper">
                <div class="id-card-box">
                    <div class="aadhaar-header">üö© ‡§∏‡§®‡§æ‡§§‡§®‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§° - <span id="displayOrgFront">‡§ù‡§æ‡§Å‡§∏‡•Ä ‡§ï‡•á‡§∏‡§∞ ‡§¶‡§≤</span> üö©</div>
                    <div class="aadhaar-body">
                        <img src="icon.jpg" class="watermark-bg">
                        <img id="cardPhoto" src="" class="id-photo">
                        <div class="aadhaar-info">
                            <b>Name</b><span id="cardName">...</span>
                            <b>Father</b><span id="cardFather">...</span>
                            <b>DOB</b><span id="cardDOB">...</span>
                            <b style="margin-top:5px;">ID: <span id="cardIdNumber" style="color:red;">...</span></b>
                        </div>
                        <img id="cardQR" src="" style="width: 60px; height: 60px; align-self: flex-end;">
                    </div>
                    <div class="aadhaar-footer">‡§Æ‡•á‡§∞‡§æ ‡§∏‡§®‡§æ‡§§‡§® ‡§Æ‡•á‡§∞‡•Ä ‡§™‡§π‡§ö‡§æ‡§® üö©</div>
                </div>

                <div class="id-card-box">
                    <div class="aadhaar-header">ADDRESS DETAILS</div>
                    <div class="aadhaar-body" style="flex-direction: column; justify-content: center;">
                        <img src="icon.jpg" class="watermark-bg">
                        <div style="z-index: 1; padding: 0 10px; text-align: left;">
                            <b>Permanent Address:</b><p id="cardAddress" style="font-size: 13px; margin: 3px 0; font-weight: 600;">...</p>
                            <br>
                            <b>Email:</b><p id="cardEmail" style="font-size: 12px; margin: 3px 0;">...</p>
                        </div>
                    </div>
                    <div class="aadhaar-footer" style="font-size: 12px;">jhansi-kesari-dal.web.app</div>
                </div>
            </div>
        </div>
        <button class="btn" onclick="downloadID()" style="background:#333;">‚¨áÔ∏è ID ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</button>
        <button class="btn" style="background:#fff; color:#333; border:1px solid #ccc; margin-top:10px;" onclick="switchTab('join-page')">‡§µ‡§æ‡§™‡§∏</button>
    </div>

    <script>
        // ‡§´‡§æ‡§Ø‡§∞‡§¨‡•á‡§∏ ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§®
        const firebaseConfig = { apiKey: "AIzaSyDPHcufGQsK_-i37FEKrlZgHq_bl8WCH90", authDomain: "jhansi-kesari-dal.firebaseapp.com", projectId: "jhansi-kesari-dal", storageBucket: "jhansi-kesari-dal.firebasestorage.app", messagingSenderId: "170440159668", appId: "1:170440159668:web:8798c72e4e6d5b7a2dc2e1" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        var photoData = "", docValidFlag = false;

        function switchTab(p) { document.querySelectorAll('.container').forEach(c => c.classList.remove('active-page')); document.getElementById(p).classList.add('active-page'); }

        // --- ‡§°‡•Å‡§™‡•ç‡§≤‡•Ä‡§ï‡•á‡§ü ‡§Ü‡§à‡§°‡•Ä ‡§∞‡•ã‡§ï‡§•‡§æ‡§Æ ‡§≤‡•â‡§ú‡§ø‡§ï ---
        async function generateUserID() {
            var n = document.getElementById('userName').value.trim();
            var f = document.getElementById('fatherName').value.trim();
            var dob = document.getElementById('dob').value;
            var org = document.getElementById('userOrgSelect').value;

            // ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç: ‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•à?
            const qs = await db.collection("members")
                .where("name", "==", n)
                .where("father", "==", f)
                .where("dob", "==", dob).get();

            if (!qs.empty) {
                alert("‡§Ü‡§™‡§ï‡•Ä ID ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§¨‡§®‡•Ä ‡§π‡•à! ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ID ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ ‚úÖ");
                setupCard(qs.docs[0].data());
                return;
            }

            // ‡§®‡§Ø‡§æ ID ‡§¨‡§®‡§æ‡§®‡§æ
            const rid = "SAN-" + (Math.floor(Math.random() * 900000) + 100000);
            const data = { id: rid, name: n, father: f, dob: dob, photo: photoData, organization: org, address: document.getElementById('userAddress').value, email: document.getElementById('userEmail').value };
            
            await db.collection("members").doc(rid).set(data);
            setupCard(data);
        }

        // --- Undefined ‡§®‡§æ‡§Æ ‡§´‡§ø‡§ï‡•ç‡§∏ ---
        function setupCard(d) {
            document.getElementById('cardName').innerText = d.name;
            document.getElementById('cardFather').innerText = d.father;
            document.getElementById('cardDOB').innerText = d.dob;
            document.getElementById('cardIdNumber').innerText = d.id;
            document.getElementById('cardPhoto').src = d.photo;
            document.getElementById('cardAddress').innerText = d.address || "N/A";
            document.getElementById('cardEmail').innerText = d.email || "N/A";
            document.getElementById('displayOrgFront').innerText = d.organization || "‡§ù‡§æ‡§Å‡§∏‡•Ä ‡§ï‡•á‡§∏‡§∞ ‡§¶‡§≤";
            document.getElementById('cardQR').src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=ID:${d.id}`;
            switchTab('id-page');
        }

        function loginWithGoogle() { var p = new firebase.auth.GoogleAuthProvider(); firebase.auth().signInWithPopup(p).then((r) => { document.getElementById('userName').value = r.user.displayName; document.getElementById('userEmail').value = r.user.email; document.getElementById('googleLoginBtn').style.display = 'none'; checkSubmitAbility(); }); }
        async function validateGovtDocument(input) { if (!input.files[0]) return; Tesseract.recognize(input.files[0], 'eng+hin').then(({ data: { text } }) => { if (text.toLowerCase().includes("india") || text.toLowerCase().includes("‡§Ü‡§ß‡§æ‡§∞")) { docValidFlag = true; document.getElementById('docStatus').innerText = "‚úÖ ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º"; checkSubmitAbility(); } else { alert("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º!"); } }); }
        function compressAndPreview(input, pId) { var reader = new FileReader(); reader.onload = function(e) { photoData = e.target.result; document.getElementById(pId).src = photoData; document.getElementById(pId).style.display = 'block'; checkSubmitAbility(); }; reader.readAsDataURL(input.files[0]); }
        function checkSubmitAbility() { if (docValidFlag && photoData !== "") document.getElementById('submitBtn').disabled = false; }
        function downloadID() { html2canvas(document.getElementById('captureArea'), { scale: 3, useCORS: true }).then(canvas => { var link = document.createElement('a'); link.download = 'JKD_Member_ID.png'; link.href = canvas.toDataURL(); link.click(); }); }
    </script>
</body>
</html>
